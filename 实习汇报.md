# Week1

## FAST-LIO以及FAST-LIO-LOC

提供全局的定位数据以及初始状态提供巡检，初始状态为xyzypr(yaw / pitch / row )

- FAST-LIO
  - 输入：LiDAR点云以及IMU数据
  - 输出：/cloud_registered以及/Odometry 
  - **以FAST-LIO1为例，主要是分析IMU递推方程/LiDAR测量方程以及/去除运动畸变三者**。该论文中定义的状态是一个误差状态，代表了转换关系
    - IMU递推方程
    - 运动补充(去畸变)
    - LiDAR测量方程
- FAST-LIO-LOC
  - 输入：LiDAR点云以及IMU数据
  - 输出：/cloud_registered以及/Odometry 
  - **整体逻辑为:** 计算$T_{base\_link}^{map}$即计算在map坐标系中，base_link系或者称为LiDAR系的位姿。对于$T_{base\_link}^{map}$的计算主要是分为$T^{map}_{odom}$以及$T^{odom}_{base\_link}$。。在FAST-LIO通过初始化自行确定的坐标系odom中，计算每个时刻的状态$T^{odom}_{base\_link}$。利用FAST-LIO输出的转换到odom系中的LiDAR点云与全局点云配准计算$T^{map}_{odom}$，其可以补偿FAST-LIO计算出的$T^{odom}_{base\_link}$可能出现的误差。**$T^{map}_{odom}$**的初始值可以人为确定, 其值会被**ICP或者其余的点云匹配算法优化**
    - python脚本中的坐标系 map | odom | base_link 分别表示 全局坐标系，里程计坐标系(即fastlio确认的坐标系)以及固定在无人机上的坐标系
      - 初始状态：指定初始的位姿状态，即绕固定轴 roll->pitch->yaw的顺序转换四元数发送
      - 全局定位：
        - 接收：
          - /cloud_registered以及/Odometry 即从fastlio中获取到的点云以及位姿 
          - **/initial_pose 表示 odom到map系中的转换关系, 即表示odom系在map系中的什么位置，即指定了当前无人机(base_linke系)在map系中的出发位置**
        - 发布：/cur_scan_in_map | /submap | /map_to_odom
          - /submap 表示 当前map系中按照FOV裁剪出来的点
          - cur_scan_in_map 表示  odom系中的当前帧点云**(修改了坐标系以及时间戳)**
          - /map_to_odom **不断修正的odom系到map系的转换关系**
        - 函数流程
          - 点云裁剪： 利用上一帧的 $T_{odom}^{map}$以及话题接收到的$T^{odom}_{base\_link}$将全局地图转换到当前局部系base_link中进行点云裁剪，以减小点云量加速匹配**(这里是一直进行的，但按理来说odom到map的转换关系在初始状态就可以固定，后续只是修正)**  最终输出在map系中的点云数据
          - 粗匹配/静匹配 registration_at_scale：调用open3D来实现odom系到map系之间的点云匹配, 不同scale控制粗细，并返回匹配精度方便衡量
          - 发布以odometry的格式发布点云匹配结果即 $T_{odom}^{map}$
        - 融合部分：
          - 接收 /Odometry以及/map_to_odom 发送 /localization 
            - 即利用 $T_{base\_link}^{odom}$与$T_{odom}^{map}$实现整体的$T_{base\_link}^{map}$即输出最终的map系中的位置数据







- 潜在的bug：但是我逻辑是分析是没有，但不确定重力加速度g在其中的作用(用FAST-LIO1而不是用FAST-LIO2)
  - 如果直接在FAST-LIO-LOC这个部分修改位姿, 将点云匹配修改成为map与base_link系之间，那么LiDAR量测获取到的就是 $T^{map}_{base\_link}$。 在IMU实现递推的时候，对应的应该是两个时刻base_link之间的转换，再加上前一个时刻中的$T^{map}_{base\_link}$其实也是获取到当前时刻的$T^{map}_{base\_link}$，递推与量测对应相同的内容，即可以实现融合定位。







- 李群/李代数：李群与李代数之间可以通过罗德里格斯公式转换

  - 旋转矩阵 3*3 可认为是一个李群 

  - 旋转向量 3*1 可认为是一个李代数

  - **旋转矩阵自身是带有约束的（正交且行列式为 1）。它们作为优化变量时，会引入额外的约束，使优化变得困难**。在后续求导中，使用扰动模型比直接使用李代数进行求导方便

    ![在这里插入图片描述](./figure/a8fe93ce906262e70d2a976cf1640c1f.png)

    ![在这里插入图片描述](./figure/417fb25b6e0c0d9da7bfbbfa94af8227.png)



PS: 这里为什么需要求导：是不是指定一个误差函数需要迭代的时候会求导，并且一阶展开的时候会进行求导(EKF 转换测量方程)